

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>nemo.collections.asr.data_layer &mdash; nemo 0.11.0b9 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> nemo
          

          
          </a>

          
            
            
              <div class="version">
                0.11.0b9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../training.html">Fast Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../asr/intro.html">Speech Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../speaker_recognition/intro.html">Speaker Recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../speech_command/intro.html">Speech Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../voice_activity_detection/intro.html">Voice Activity Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nlp/intro.html">Natural Language Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tts/intro.html">Speech Synthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../collections/modules.html">NeMo Collections API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api-docs/modules.html">NeMo API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../chinese/intro.html">中文支持</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">nemo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>nemo.collections.asr.data_layer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for nemo.collections.asr.data_layer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2019, NVIDIA CORPORATION. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># =============================================================================</span>
<span class="sd">&quot;&quot;&quot;This package contains Neural Modules responsible for ASR data layers.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">braceexpand</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">webdataset</span> <span class="k">as</span> <span class="nn">wd</span>

<span class="kn">from</span> <span class="nn">.parts.collections</span> <span class="k">import</span> <span class="n">ASRAudioText</span>
<span class="kn">from</span> <span class="nn">.parts.dataset</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AudioDataset</span><span class="p">,</span>
    <span class="n">AudioLabelDataset</span><span class="p">,</span>
    <span class="n">KaldiFeatureDataset</span><span class="p">,</span>
    <span class="n">TranscriptDataset</span><span class="p">,</span>
    <span class="n">fixed_seq_collate_fn</span><span class="p">,</span>
    <span class="n">seq_collate_fn</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.parts.features</span> <span class="k">import</span> <span class="n">WaveformFeaturizer</span>
<span class="kn">from</span> <span class="nn">.parts.parsers</span> <span class="k">import</span> <span class="n">make_parser</span>
<span class="kn">from</span> <span class="nn">.parts.perturb</span> <span class="k">import</span> <span class="n">AudioAugmentor</span><span class="p">,</span> <span class="n">perturbation_types</span>
<span class="kn">from</span> <span class="nn">nemo.backends.pytorch</span> <span class="k">import</span> <span class="n">DataLayerNM</span>
<span class="kn">from</span> <span class="nn">nemo.core</span> <span class="k">import</span> <span class="n">DeviceType</span>
<span class="kn">from</span> <span class="nn">nemo.core.neural_types</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">nemo.utils</span> <span class="k">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">nemo.utils.decorators</span> <span class="k">import</span> <span class="n">add_port_docs</span>
<span class="kn">from</span> <span class="nn">nemo.utils.misc</span> <span class="k">import</span> <span class="n">pad_to</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;AudioToTextDataLayer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TarredAudioToTextDataLayer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;KaldiFeatureDataLayer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TranscriptDataLayer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AudioToSpeechLabelDataLayer&#39;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">_process_augmentations</span><span class="p">(</span><span class="n">augmenter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AudioAugmentor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Process list of online data augmentations.</span>

<span class="sd">    Accepts either an AudioAugmentor object with pre-defined augmentations,</span>
<span class="sd">    or a dictionary that points to augmentations that have been defined.</span>

<span class="sd">    If a dictionary is passed, must follow the below structure:</span>
<span class="sd">    Dict[str, Dict[str, Any]]: Which refers to a dictionary of string</span>
<span class="sd">    names for augmentations, defined in `asr/parts/perturb.py`.</span>

<span class="sd">    The inner dictionary may contain key-value arguments of the specific</span>
<span class="sd">    augmentation, along with an essential key `prob`. `prob` declares the</span>
<span class="sd">    probability of the augmentation being applied, and must be a float</span>
<span class="sd">    value in the range [0, 1].</span>

<span class="sd">    # Example in YAML config file</span>

<span class="sd">    Augmentations are generally applied only during training, so we can add</span>
<span class="sd">    these augmentations to our yaml config file, and modify the behaviour</span>
<span class="sd">    for training and evaluation.</span>

<span class="sd">    ```yaml</span>
<span class="sd">    AudioToSpeechLabelDataLayer:</span>
<span class="sd">        ...  # Parameters shared between train and evaluation time</span>
<span class="sd">        train:</span>
<span class="sd">            augmentor:</span>
<span class="sd">                shift:</span>
<span class="sd">                    prob: 0.5</span>
<span class="sd">                    min_shift_ms: -5.0</span>
<span class="sd">                    max_shift_ms: 5.0</span>
<span class="sd">                white_noise:</span>
<span class="sd">                    prob: 1.0</span>
<span class="sd">                    min_level: -90</span>
<span class="sd">                    max_level: -46</span>
<span class="sd">                ...</span>
<span class="sd">        eval:</span>
<span class="sd">            ...</span>
<span class="sd">    ```</span>

<span class="sd">    Then in the training script,</span>

<span class="sd">    ```python</span>
<span class="sd">    import copy</span>
<span class="sd">    from ruamel.yaml import YAML</span>

<span class="sd">    yaml = YAML(typ=&quot;safe&quot;)</span>
<span class="sd">    with open(model_config) as f:</span>
<span class="sd">        params = yaml.load(f)</span>

<span class="sd">    # Train Config for Data Loader</span>
<span class="sd">    train_dl_params = copy.deepcopy(params[&quot;AudioToTextDataLayer&quot;])</span>
<span class="sd">    train_dl_params.update(params[&quot;AudioToTextDataLayer&quot;][&quot;train&quot;])</span>
<span class="sd">    del train_dl_params[&quot;train&quot;]</span>
<span class="sd">    del train_dl_params[&quot;eval&quot;]</span>

<span class="sd">    data_layer_train = nemo_asr.AudioToTextDataLayer(</span>
<span class="sd">        ...,</span>
<span class="sd">        **train_dl_params,</span>
<span class="sd">    )</span>

<span class="sd">    # Evaluation Config for Data Loader</span>
<span class="sd">    eval_dl_params = copy.deepcopy(params[&quot;AudioToTextDataLayer&quot;])</span>
<span class="sd">    eval_dl_params.update(params[&quot;AudioToTextDataLayer&quot;][&quot;eval&quot;])</span>
<span class="sd">    del eval_dl_params[&quot;train&quot;]</span>
<span class="sd">    del eval_dl_params[&quot;eval&quot;]</span>

<span class="sd">    data_layer_eval = nemo_asr.AudioToTextDataLayer(</span>
<span class="sd">        ...,</span>
<span class="sd">        **eval_dl_params,</span>
<span class="sd">    )</span>
<span class="sd">    ```</span>

<span class="sd">    # Registering your own Augmentations</span>

<span class="sd">    To register custom augmentations to obtain the above convenience of</span>
<span class="sd">    the declaring the augmentations in YAML, you can put additional keys in</span>
<span class="sd">    `perturbation_types` dictionary as follows.</span>

<span class="sd">    ```python</span>
<span class="sd">    from nemo.collections.asr.parts import perturb</span>

<span class="sd">    # Define your own perturbation here</span>
<span class="sd">    class CustomPerturbation(perturb.Perturbation):</span>
<span class="sd">        ...</span>

<span class="sd">    perturb.register_perturbation(name_of_perturbation, CustomPerturbation)</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        augmenter: AudioAugmentor object or</span>
<span class="sd">            dictionary of str -&gt; kwargs (dict) which is parsed and used</span>
<span class="sd">            to initialize an AudioAugmentor.</span>
<span class="sd">            Note: It is crucial that each individual augmentation has</span>
<span class="sd">            a keyword `prob`, that defines a float probability in the</span>
<span class="sd">            the range [0, 1] of this augmentation being applied.</span>
<span class="sd">            If this keyword is not present, then the augmentation is</span>
<span class="sd">            disabled and a warning is logged.</span>

<span class="sd">    Returns: AudioAugmentor object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">augmenter</span><span class="p">,</span> <span class="n">AudioAugmentor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">augmenter</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">augmenter</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot parse augmenter. Must be a dict or an AudioAugmentor object &quot;</span><span class="p">)</span>

    <span class="n">augmenter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">augmenter</span><span class="p">)</span>

    <span class="n">augmentations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">augment_name</span><span class="p">,</span> <span class="n">augment_kwargs</span> <span class="ow">in</span> <span class="n">augmenter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">augment_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="n">f</span><span class="s1">&#39;Augmentation &quot;</span><span class="si">{augment_name}</span><span class="s1">&quot; will not be applied as &#39;</span>
                <span class="n">f</span><span class="s1">&#39;keyword argument &quot;prob&quot; was not defined for this augmentation.&#39;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">augment_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;prob&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`prob` must be a float value between 0 and 1.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">augmentation</span> <span class="o">=</span> <span class="n">perturbation_types</span><span class="p">[</span><span class="n">augment_name</span><span class="p">](</span><span class="o">**</span><span class="n">augment_kwargs</span><span class="p">)</span>
                <span class="n">augmentations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prob</span><span class="p">,</span> <span class="n">augmentation</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid perturbation name. Allowed values : {perturbation_types.keys()}&quot;</span><span class="p">)</span>

    <span class="n">augmenter</span> <span class="o">=</span> <span class="n">AudioAugmentor</span><span class="p">(</span><span class="n">perturbations</span><span class="o">=</span><span class="n">augmentations</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">augmenter</span>


<div class="viewcode-block" id="AudioToTextDataLayer"><a class="viewcode-back" href="../../../../collections/nemo_asr.html#nemo.collections.asr.data_layer.AudioToTextDataLayer">[docs]</a><span class="k">class</span> <span class="nc">AudioToTextDataLayer</span><span class="p">(</span><span class="n">DataLayerNM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data Layer for general ASR tasks.</span>

<span class="sd">    Module which reads ASR labeled data. It accepts comma-separated</span>
<span class="sd">    JSON manifest files describing the correspondence between wav audio files</span>
<span class="sd">    and their transcripts. JSON files should be of the following format::</span>

<span class="sd">        {&quot;audio_filepath&quot;: path_to_wav_0, &quot;duration&quot;: time_in_sec_0, &quot;text&quot;: \</span>
<span class="sd">transcript_0}</span>
<span class="sd">        ...</span>
<span class="sd">        {&quot;audio_filepath&quot;: path_to_wav_n, &quot;duration&quot;: time_in_sec_n, &quot;text&quot;: \</span>
<span class="sd">transcript_n}</span>

<span class="sd">    Args:</span>
<span class="sd">        manifest_filepath (str): Dataset parameter.</span>
<span class="sd">            Path to JSON containing data.</span>
<span class="sd">        labels (list): Dataset parameter.</span>
<span class="sd">            List of characters that can be output by the ASR model.</span>
<span class="sd">            For Jasper, this is the 28 character set {a-z &#39;}. The CTC blank</span>
<span class="sd">            symbol is automatically added later for models using ctc.</span>
<span class="sd">        batch_size (int): batch size</span>
<span class="sd">        sample_rate (int): Target sampling rate for data. Audio files will be</span>
<span class="sd">            resampled to sample_rate if it is not already.</span>
<span class="sd">            Defaults to 16000.</span>
<span class="sd">        int_values (bool): Bool indicating whether the audio file is saved as</span>
<span class="sd">            int data or float data.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        bos_id (id): Dataset parameter.</span>
<span class="sd">            Beginning of string symbol id used for seq2seq models.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        eos_id (id): Dataset parameter.</span>
<span class="sd">            End of string symbol id used for seq2seq models.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        pad_id (id): Token used to pad when collating samples in batches.</span>
<span class="sd">            If this is None, pads using 0s.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        min_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration less than min_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to 0.1.</span>
<span class="sd">        max_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration more than max_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        normalize_transcripts (bool): Dataset parameter.</span>
<span class="sd">            Whether to use automatic text cleaning.</span>
<span class="sd">            It is highly recommended to manually clean text for best results.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        trim_silence (bool): Whether to use trim silence from beginning and end</span>
<span class="sd">            of audio signal using librosa.effects.trim().</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        load_audio (bool): Dataset parameter.</span>
<span class="sd">            Controls whether the dataloader loads the audio signal and</span>
<span class="sd">            transcript or just the transcript.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        drop_last (bool): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        shuffle (bool): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        num_workers (int): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        perturb_config (dict): Currently disabled.</span>
<span class="sd">        augmentor (AudioAugmentor or dict): Optional AudioAugmentor or</span>
<span class="sd">            dictionary of str -&gt; kwargs (dict) which is parsed and used</span>
<span class="sd">            to initialize an AudioAugmentor.</span>
<span class="sd">            Note: It is crucial that each individual augmentation has</span>
<span class="sd">            a keyword `prob`, that defines a float probability in the</span>
<span class="sd">            the range [0, 1] of this augmentation being applied.</span>
<span class="sd">            If this keyword is not present, then the augmentation is</span>
<span class="sd">            disabled and a warning is logged.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@add_port_docs</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">output_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns definitions of module output ports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># &#39;audio_signal&#39;: NeuralType({0: AxisType(BatchTag), 1: AxisType(TimeTag)}),</span>
            <span class="c1"># &#39;a_sig_length&#39;: NeuralType({0: AxisType(BatchTag)}),</span>
            <span class="c1"># &#39;transcripts&#39;: NeuralType({0: AxisType(BatchTag), 1: AxisType(TimeTag)}),</span>
            <span class="c1"># &#39;transcript_length&#39;: NeuralType({0: AxisType(BatchTag)}),</span>
            <span class="s1">&#39;audio_signal&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span>
                <span class="n">AudioSignal</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">AudioSignal</span><span class="p">(),</span>
            <span class="p">),</span>
            <span class="s1">&#39;a_sig_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcripts&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">LabelsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcript_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">manifest_filepath</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span>
        <span class="n">int_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pad_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_duration</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize_transcripts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">trim_silence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">load_audio</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">augmentor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">AudioAugmentor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>

        <span class="k">if</span> <span class="n">augmentor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">augmentor</span> <span class="o">=</span> <span class="n">_process_augmentations</span><span class="p">(</span><span class="n">augmentor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_featurizer</span> <span class="o">=</span> <span class="n">WaveformFeaturizer</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">,</span> <span class="n">int_values</span><span class="o">=</span><span class="n">int_values</span><span class="p">,</span> <span class="n">augmentor</span><span class="o">=</span><span class="n">augmentor</span>
        <span class="p">)</span>

        <span class="c1"># Set up dataset</span>
        <span class="n">dataset_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;manifest_filepath&#39;</span><span class="p">:</span> <span class="n">manifest_filepath</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;featurizer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_featurizer</span><span class="p">,</span>
            <span class="s1">&#39;max_duration&#39;</span><span class="p">:</span> <span class="n">max_duration</span><span class="p">,</span>
            <span class="s1">&#39;min_duration&#39;</span><span class="p">:</span> <span class="n">min_duration</span><span class="p">,</span>
            <span class="s1">&#39;normalize&#39;</span><span class="p">:</span> <span class="n">normalize_transcripts</span><span class="p">,</span>
            <span class="s1">&#39;trim&#39;</span><span class="p">:</span> <span class="n">trim_silence</span><span class="p">,</span>
            <span class="s1">&#39;bos_id&#39;</span><span class="p">:</span> <span class="n">bos_id</span><span class="p">,</span>
            <span class="s1">&#39;eos_id&#39;</span><span class="p">:</span> <span class="n">eos_id</span><span class="p">,</span>
            <span class="s1">&#39;load_audio&#39;</span><span class="p">:</span> <span class="n">load_audio</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">AudioDataset</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>

        <span class="c1"># Set up data loader</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">AllGpu</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parallelizing Datalayer.&quot;</span><span class="p">)</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

        <span class="n">pad_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pad_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pad_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">seq_collate_fn</span><span class="p">,</span> <span class="n">token_pad_value</span><span class="o">=</span><span class="n">pad_id</span><span class="p">),</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="n">drop_last</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span> <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span></div>


<div class="viewcode-block" id="TarredAudioToTextDataLayer"><a class="viewcode-back" href="../../../../collections/nemo_asr.html#nemo.collections.asr.data_layer.TarredAudioToTextDataLayer">[docs]</a><span class="k">class</span> <span class="nc">TarredAudioToTextDataLayer</span><span class="p">(</span><span class="n">DataLayerNM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data Layer for general ASR tasks, where the audio files are tarred.</span>

<span class="sd">    Module which reads ASR labeled data. It accepts a single comma-separated JSON manifest file, as well as the</span>
<span class="sd">    path(s) to the tarball(s) with the wav files. Each line of the manifest should contain the information for one</span>
<span class="sd">    audio file, including at least the transcript and name of the audio file (doesn&#39;t have to be exact, only the</span>
<span class="sd">    basename must be the same).</span>

<span class="sd">    Valid formats for the audio_tar_filepaths argument include (1) a single string that can be brace-expanded,</span>
<span class="sd">    e.g. &#39;path/to/audio.tar&#39; or &#39;path/to/audio_{1..100}.tar.gz&#39;, or (2) a list of file paths that will not be</span>
<span class="sd">    brace-expanded, e.g. [&#39;audio_1.tar&#39;, &#39;audio_2.tar&#39;, ...]. See the WebDataset documentation for more information</span>
<span class="sd">    about accepted data and input formats.</span>

<span class="sd">    If using torch.distributed, the number of shards should be divisible by the number of workers to ensure an</span>
<span class="sd">    even split among workers. If it is not divisible, logging will give a warning but we will continue.</span>

<span class="sd">    Notice that a few arguments are different from the AudioToTextDataLayer; for example, shuffle (bool) has been</span>
<span class="sd">    replaced by shuffle_n (int).</span>

<span class="sd">    Additionally, please note that the len() of this DataLayer is assumed to be the length of the manifest. Be aware</span>
<span class="sd">    of this especially if the tarred audio is a subset of the samples represented in the manifest.</span>

<span class="sd">    Args:</span>
<span class="sd">        audio_tar_filepaths: Either a list of audio tarball filepaths, or a</span>
<span class="sd">            string (can be brace-expandable).</span>
<span class="sd">        manifest_filepath (str): Path to the manifest.</span>
<span class="sd">        labels (list): List of characters that can be output by the ASR model.</span>
<span class="sd">            For Jasper, this is the 28 character set {a-z &#39;}. The CTC blank</span>
<span class="sd">            symbol is automatically added later for models using ctc.</span>
<span class="sd">        batch_size (int): batch size</span>
<span class="sd">        sample_rate (int): Target sampling rate for data. Audio files will be</span>
<span class="sd">            resampled to sample_rate if it is not already.</span>
<span class="sd">            Defaults to 16000.</span>
<span class="sd">        int_values (bool): Bool indicating whether the audio file is saved as</span>
<span class="sd">            int data or float data.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        bos_id (id): Dataset parameter.</span>
<span class="sd">            Beginning of string symbol id used for seq2seq models.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        eos_id (id): Dataset parameter.</span>
<span class="sd">            End of string symbol id used for seq2seq models.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        pad_id (id): Token used to pad when collating samples in batches.</span>
<span class="sd">            If this is None, pads using 0s.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        min_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration less than min_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to 0.1.</span>
<span class="sd">        max_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration more than max_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        normalize_transcripts (bool): Dataset parameter.</span>
<span class="sd">            Whether to use automatic text cleaning.</span>
<span class="sd">            It is highly recommended to manually clean text for best results.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        trim_silence (bool): Whether to use trim silence from beginning and end</span>
<span class="sd">            of audio signal using librosa.effects.trim().</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        shuffle_n (int): How many samples to look ahead and load to be shuffled.</span>
<span class="sd">            See WebDataset documentation for more details.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        num_workers (int): See PyTorch DataLoader. Defaults to 0.</span>
<span class="sd">        augmentor (AudioAugmentor or dict): Optional AudioAugmentor or</span>
<span class="sd">            dictionary of str -&gt; kwargs (dict) which is parsed and used</span>
<span class="sd">            to initialize an AudioAugmentor.</span>
<span class="sd">            Note: It is crucial that each individual augmentation has</span>
<span class="sd">            a keyword `prob`, that defines a float probability in the</span>
<span class="sd">            the range [0, 1] of this augmentation being applied.</span>
<span class="sd">            If this keyword is not present, then the augmentation is</span>
<span class="sd">            disabled and a warning is logged.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@add_port_docs</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">output_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns definitions of module output ports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;audio_signal&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span>
                <span class="n">AudioSignal</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">AudioSignal</span><span class="p">(),</span>
            <span class="p">),</span>
            <span class="s1">&#39;a_sig_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcripts&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">LabelsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcript_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">audio_tar_filepaths</span><span class="p">,</span>
        <span class="n">manifest_filepath</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span>
        <span class="n">int_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pad_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_duration</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize_transcripts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">trim_silence</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shuffle_n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">augmentor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">AudioAugmentor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>

        <span class="k">if</span> <span class="n">augmentor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">augmentor</span> <span class="o">=</span> <span class="n">_process_augmentations</span><span class="p">(</span><span class="n">augmentor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">ASRAudioText</span><span class="p">(</span>
            <span class="n">manifests_files</span><span class="o">=</span><span class="n">manifest_filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
            <span class="n">parser</span><span class="o">=</span><span class="n">make_parser</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">do_normalize</span><span class="o">=</span><span class="n">normalize_transcripts</span><span class="p">),</span>
            <span class="n">min_duration</span><span class="o">=</span><span class="n">min_duration</span><span class="p">,</span>
            <span class="n">max_duration</span><span class="o">=</span><span class="n">max_duration</span><span class="p">,</span>
            <span class="n">index_by_file_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Must set this so the manifest lines can be indexed by file ID</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">WaveformFeaturizer</span><span class="p">(</span><span class="n">sample_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">,</span> <span class="n">int_values</span><span class="o">=</span><span class="n">int_values</span><span class="p">,</span> <span class="n">augmentor</span><span class="o">=</span><span class="n">augmentor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trim</span> <span class="o">=</span> <span class="n">trim_silence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span> <span class="o">=</span> <span class="n">eos_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span> <span class="o">=</span> <span class="n">bos_id</span>

        <span class="c1"># Used in creating a sampler (in Actions).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="n">pad_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pad_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pad_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collate_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">seq_collate_fn</span><span class="p">,</span> <span class="n">token_pad_value</span><span class="o">=</span><span class="n">pad_id</span><span class="p">)</span>

        <span class="c1"># Check for distributed and partition shards accordingly</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">():</span>
            <span class="n">global_rank</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
            <span class="n">world_size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">audio_tar_filepaths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">braceexpand</span><span class="o">.</span><span class="n">braceexpand</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">)</span> <span class="o">%</span> <span class="n">world_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Number of shards in tarred dataset ({len(audio_tar_filepaths)}) is not divisible &quot;</span>
                    <span class="n">f</span><span class="s2">&quot;by number of distributed workers (</span><span class="si">{world_size}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

            <span class="n">begin_idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">)</span> <span class="o">//</span> <span class="n">world_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">global_rank</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">begin_idx</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">)</span> <span class="o">//</span> <span class="n">world_size</span><span class="p">)</span>
            <span class="n">audio_tar_filepaths</span> <span class="o">=</span> <span class="n">audio_tar_filepaths</span><span class="p">[</span><span class="n">begin_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

        <span class="c1"># Put together WebDataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">wd</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">audio_tar_filepaths</span><span class="p">)</span>
            <span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_n</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">audio</span><span class="o">=</span><span class="s1">&#39;wav&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;__key__&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">to_tuple</span><span class="p">(</span><span class="s1">&#39;audio&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">)</span>
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_sample</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used to remove samples that have been filtered out by ASRAudioText already.</span>
<span class="sd">        Otherwise, we would get a KeyError as _build_sample attempts to find the manifest entry for a sample</span>
<span class="sd">        that was filtered out (e.g. for duration).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">TarredAudioFilter</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">iterator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>

            <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">audio_bytes</span><span class="p">,</span> <span class="n">audio_filename</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">)</span>
                    <span class="n">file_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">audio_filename</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">file_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">audio_bytes</span><span class="p">,</span> <span class="n">audio_filename</span>

        <span class="k">return</span> <span class="n">TarredAudioFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tup</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds the training sample by combining the data from the WebDataset with the manifest info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">audio_bytes</span><span class="p">,</span> <span class="n">audio_filename</span> <span class="o">=</span> <span class="n">tup</span>

        <span class="c1"># Grab manifest entry from self.collection</span>
        <span class="n">file_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">audio_filename</span><span class="p">))</span>
        <span class="n">manifest_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">file_id</span><span class="p">]</span>
        <span class="n">manifest_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">[</span><span class="n">manifest_idx</span><span class="p">]</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">manifest_entry</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Convert audio bytes to IO stream for processing (for SoundFile to read)</span>
        <span class="n">audio_filestream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">audio_bytes</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">audio_filestream</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">manifest_entry</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">audio_filestream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Audio features</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

        <span class="c1"># Text features</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">tl</span> <span class="o">=</span> <span class="n">manifest_entry</span><span class="o">.</span><span class="n">text_tokens</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">manifest_entry</span><span class="o">.</span><span class="n">text_tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span>
            <span class="n">tl</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_id</span><span class="p">]</span>
            <span class="n">tl</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">fl</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tl</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="KaldiFeatureDataLayer"><a class="viewcode-back" href="../../../../collections/nemo_asr.html#nemo.collections.asr.data_layer.KaldiFeatureDataLayer">[docs]</a><span class="k">class</span> <span class="nc">KaldiFeatureDataLayer</span><span class="p">(</span><span class="n">DataLayerNM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data layer for reading generic Kaldi-formatted data.</span>

<span class="sd">    Module that reads ASR labeled data that is in a Kaldi-compatible format.</span>
<span class="sd">    It assumes that you have a directory that contains:</span>

<span class="sd">    - feats.scp: A mapping from utterance IDs to .ark files that</span>
<span class="sd">            contains the corresponding MFCC (or other format) data</span>
<span class="sd">    - text: A mapping from utterance IDs to transcripts</span>
<span class="sd">    - utt2dur (optional): A mapping from utterance IDs to audio durations,</span>
<span class="sd">            needed if you want to filter based on duration</span>

<span class="sd">    Args:</span>
<span class="sd">        kaldi_dir (str): Directory that contains the above files.</span>
<span class="sd">        labels (list): List of characters that can be output by the ASR model,</span>
<span class="sd">            e.g. {a-z &#39;} for Jasper. The CTC blank symbol is automatically</span>
<span class="sd">            added later for models using CTC.</span>
<span class="sd">        batch_size (int): batch size</span>
<span class="sd">        eos_id (str): End of string symbol used for seq2seq models.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        min_duration (float): All training files which have a duration less</span>
<span class="sd">            than min_duration are dropped. Can&#39;t be used if the `utt2dur` file</span>
<span class="sd">            does not exist. Defaults to None.</span>
<span class="sd">        max_duration (float): All training files which have a duration more</span>
<span class="sd">            than max_duration are dropped. Can&#39;t be used if the `utt2dur` file</span>
<span class="sd">            does not exist. Defaults to None.</span>
<span class="sd">        normalize_transcripts (bool): Whether to use automatic text cleaning.</span>
<span class="sd">            It is highly recommended to manually clean text for best results.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        drop_last (bool): See PyTorch DataLoader. Defaults to False.</span>
<span class="sd">        shuffle (bool): See PyTorch DataLoader. Defaults to True.</span>
<span class="sd">        num_workers (int): See PyTorch DataLoader. Defaults to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@add_port_docs</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">output_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns definitions of module output ports.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># &#39;processed_signal&#39;: NeuralType(</span>
            <span class="c1">#    {0: AxisType(BatchTag), 1: AxisType(SpectrogramSignalTag), 2: AxisType(ProcessedTimeTag),}</span>
            <span class="c1"># ),</span>
            <span class="c1"># &#39;processed_length&#39;: NeuralType({0: AxisType(BatchTag)}),</span>
            <span class="c1"># &#39;transcripts&#39;: NeuralType({0: AxisType(BatchTag), 1: AxisType(TimeTag)}),</span>
            <span class="c1"># &#39;transcript_length&#39;: NeuralType({0: AxisType(BatchTag)}),</span>
            <span class="s1">&#39;processed_signal&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">SpectrogramType</span><span class="p">()),</span>
            <span class="s1">&#39;processed_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcripts&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">LabelsType</span><span class="p">()),</span>
            <span class="s1">&#39;transcript_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kaldi_dir</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">min_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize_transcripts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Set up dataset</span>
        <span class="n">dataset_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kaldi_dir&quot;</span><span class="p">:</span> <span class="n">kaldi_dir</span><span class="p">,</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s2">&quot;min_duration&quot;</span><span class="p">:</span> <span class="n">min_duration</span><span class="p">,</span>
            <span class="s2">&quot;max_duration&quot;</span><span class="p">:</span> <span class="n">max_duration</span><span class="p">,</span>
            <span class="s2">&quot;normalize&quot;</span><span class="p">:</span> <span class="n">normalize_transcripts</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">KaldiFeatureDataset</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_params</span><span class="p">)</span>

        <span class="c1"># Set up data loader</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">AllGpu</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parallelizing DATALAYER&quot;</span><span class="p">)</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_collate_fn</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="n">drop_last</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span> <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collate batch of (features, feature len, tokens, tokens len).</span>
<span class="sd">        Kaldi generally uses MFCC (and PLP) features.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch: A batch of elements, where each element is a tuple of</span>
<span class="sd">                features, feature length, tokens, and token</span>
<span class="sd">                length for a single sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same batch, with the features and token length padded</span>
<span class="sd">            to the maximum of the batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find max lengths of features and tokens in the batch</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">feat_lens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">token_lens</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">max_feat_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">feat_lens</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">max_tokens_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">token_lens</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># Pad features and tokens to max</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">feat_len</span><span class="p">,</span> <span class="n">tkns</span><span class="p">,</span> <span class="n">tkns_len</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">feat_len</span> <span class="o">=</span> <span class="n">feat_len</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">feat_len</span> <span class="o">&lt;</span> <span class="n">max_feat_len</span><span class="p">:</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_feat_len</span> <span class="o">-</span> <span class="n">feat_len</span><span class="p">]</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>

            <span class="n">tkns_len</span> <span class="o">=</span> <span class="n">tkns_len</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tkns_len</span> <span class="o">&lt;</span> <span class="n">max_tokens_len</span><span class="p">:</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tokens_len</span> <span class="o">-</span> <span class="n">tkns_len</span><span class="p">]</span>
                <span class="n">tkns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">tkns</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tkns</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">feature_lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">feat_lens</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">token_lens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">token_lens</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">feature_lens</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">token_lens</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span></div>


<div class="viewcode-block" id="TranscriptDataLayer"><a class="viewcode-back" href="../../../../collections/nemo_asr.html#nemo.collections.asr.data_layer.TranscriptDataLayer">[docs]</a><span class="k">class</span> <span class="nc">TranscriptDataLayer</span><span class="p">(</span><span class="n">DataLayerNM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple Neural Module for loading textual transcript data.</span>
<span class="sd">    The path, labels, and eos_id arguments are dataset parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        pad_id (int): Label position of padding symbol</span>
<span class="sd">        batch_size (int): Size of batches to generate in data loader</span>
<span class="sd">        drop_last (bool): Whether we drop last (possibly) incomplete batch.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        num_workers (int): Number of processes to work on data loading (0 for</span>
<span class="sd">            just main process).</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@add_port_docs</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">output_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns definitions of module output ports.</span>

<span class="sd">        texts:</span>
<span class="sd">            0: AxisType(BatchTag)</span>

<span class="sd">            1: AxisType(TimeTag)</span>

<span class="sd">        texts_length:</span>
<span class="sd">            0: AxisType(BatchTag)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># &#39;texts&#39;: NeuralType({0: AxisType(BatchTag), 1: AxisType(TimeTag)}),</span>
            <span class="c1"># &#39;texts_length&#39;: NeuralType({0: AxisType(BatchTag)}),</span>
            <span class="s1">&#39;texts&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">LabelsType</span><span class="p">()),</span>
            <span class="s1">&#39;texts_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="n">bos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pad_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Set up dataset</span>
        <span class="n">dataset_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;bos_id&#39;</span><span class="p">:</span> <span class="n">bos_id</span><span class="p">,</span>
            <span class="s1">&#39;eos_id&#39;</span><span class="p">:</span> <span class="n">eos_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">TranscriptDataset</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_params</span><span class="p">)</span>

        <span class="c1"># Set up data loader</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">AllGpu</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pad_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">pad_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pad_id</span>

        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_collate_fn</span><span class="p">,</span> <span class="n">pad_id</span><span class="o">=</span><span class="n">pad_id</span><span class="p">,</span> <span class="n">pad8</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="n">drop_last</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span> <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pad_id</span><span class="p">,</span> <span class="n">pad8</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">texts_list</span><span class="p">,</span> <span class="n">texts_len</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">texts_len</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pad8</span><span class="p">:</span>
            <span class="n">max_len</span> <span class="o">=</span> <span class="n">pad_to</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="n">texts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">texts_list</span><span class="p">),</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="n">texts</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">pad_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts_list</span><span class="p">):</span>
            <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Texts in collate function have shape </span><span class="si">{texts.shape}</span><span class="s2">,&quot;</span> <span class="n">f</span><span class="s2">&quot; should have 2 dimensions.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">texts</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">texts_len</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span></div>


<span class="c1"># Ported from https://github.com/NVIDIA/OpenSeq2Seq/blob/master/open_seq2seq/data/speech2text/speech_commands.py</span>
<div class="viewcode-block" id="AudioToSpeechLabelDataLayer"><a class="viewcode-back" href="../../../../collections/nemo_asr.html#nemo.collections.asr.data_layer.AudioToSpeechLabelDataLayer">[docs]</a><span class="k">class</span> <span class="nc">AudioToSpeechLabelDataLayer</span><span class="p">(</span><span class="n">DataLayerNM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data Layer for general speech classification.</span>

<span class="sd">    Module which reads speech recognition with target label. It accepts comma-separated</span>
<span class="sd">    JSON manifest files describing the correspondence between wav audio files</span>
<span class="sd">    and their target labels. JSON files should be of the following format::</span>

<span class="sd">        {&quot;audio_filepath&quot;: path_to_wav_0, &quot;duration&quot;: time_in_sec_0, &quot;label&quot;: \</span>
<span class="sd">target_label_0, &quot;offset&quot;: offset_in_sec_0}</span>
<span class="sd">        ...</span>
<span class="sd">        {&quot;audio_filepath&quot;: path_to_wav_n, &quot;duration&quot;: time_in_sec_n, &quot;label&quot;: \</span>
<span class="sd">target_label_n, &quot;offset&quot;: offset_in_sec_n}</span>

<span class="sd">    Args:</span>
<span class="sd">        manifest_filepath (str): Dataset parameter.</span>
<span class="sd">            Path to JSON containing data.</span>
<span class="sd">        labels (list): Dataset parameter.</span>
<span class="sd">            List of target classes that can be output by the speech recognition model.</span>
<span class="sd">        batch_size (int): batch size</span>
<span class="sd">        sample_rate (int): Target sampling rate for data. Audio files will be</span>
<span class="sd">            resampled to sample_rate if it is not already.</span>
<span class="sd">            Defaults to 16000.</span>
<span class="sd">        int_values (bool): Bool indicating whether the audio file is saved as</span>
<span class="sd">            int data or float data.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        min_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration less than min_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to 0.1.</span>
<span class="sd">        max_duration (float): Dataset parameter.</span>
<span class="sd">            All training files which have a duration more than max_duration</span>
<span class="sd">            are dropped. Note: Duration is read from the manifest JSON.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        trim_silence (bool): Whether to use trim silence from beginning and end</span>
<span class="sd">            of audio signal using librosa.effects.trim().</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        load_audio (bool): Dataset parameter.</span>
<span class="sd">            Controls whether the dataloader loads the audio signal and</span>
<span class="sd">            transcript or just the transcript.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        drop_last (bool): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        shuffle (bool): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        num_workers (int): See PyTorch DataLoader.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        augmenter (AudioAugmentor or dict): Optional AudioAugmentor or</span>
<span class="sd">            dictionary of str -&gt; kwargs (dict) which is parsed and used</span>
<span class="sd">            to initialize an AudioAugmentor.</span>
<span class="sd">            Note: It is crucial that each individual augmentation has</span>
<span class="sd">            a keyword `prob`, that defines a float probability in the</span>
<span class="sd">            the range [0, 1] of this augmentation being applied.</span>
<span class="sd">            If this keyword is not present, then the augmentation is</span>
<span class="sd">            disabled and a warning is logged.</span>
<span class="sd">        time_length (int): max seconds to consider in a batch # Pass this only for speaker recognition task</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns definitions of module output ports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;audio_signal&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">((</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span> <span class="n">AudioSignal</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">)),</span>
            <span class="s1">&#39;a_sig_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LabelsType</span><span class="p">()),</span>
            <span class="s1">&#39;label_length&#39;</span><span class="p">:</span> <span class="n">NeuralType</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">),</span> <span class="n">LengthsType</span><span class="p">()),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">manifest_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">,</span>
        <span class="n">int_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">min_duration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">max_duration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trim_silence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">load_audio</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">augmentor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">AudioAugmentor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AudioToSpeechLabelDataLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_filepath</span> <span class="o">=</span> <span class="n">manifest_filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span>

        <span class="k">if</span> <span class="n">augmentor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">augmentor</span> <span class="o">=</span> <span class="n">_process_augmentations</span><span class="p">(</span><span class="n">augmentor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_featurizer</span> <span class="o">=</span> <span class="n">WaveformFeaturizer</span><span class="p">(</span><span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">int_values</span><span class="o">=</span><span class="n">int_values</span><span class="p">,</span> <span class="n">augmentor</span><span class="o">=</span><span class="n">augmentor</span><span class="p">)</span>

        <span class="n">dataset_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;manifest_filepath&#39;</span><span class="p">:</span> <span class="n">manifest_filepath</span><span class="p">,</span>
            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s1">&#39;featurizer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_featurizer</span><span class="p">,</span>
            <span class="s1">&#39;max_duration&#39;</span><span class="p">:</span> <span class="n">max_duration</span><span class="p">,</span>
            <span class="s1">&#39;min_duration&#39;</span><span class="p">:</span> <span class="n">min_duration</span><span class="p">,</span>
            <span class="s1">&#39;trim&#39;</span><span class="p">:</span> <span class="n">trim_silence</span><span class="p">,</span>
            <span class="s1">&#39;load_audio&#39;</span><span class="p">:</span> <span class="n">load_audio</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">AudioLabelDataset</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">num_commands</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# of classes :</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">labels</span>
        <span class="c1"># Set up data loader</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placement</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">AllGpu</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parallelizing Datalayer.&quot;</span><span class="p">)</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">DistributedSampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">time_length</span><span class="p">:</span>
            <span class="n">collate_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fixed_seq_collate_fn</span><span class="p">,</span> <span class="n">fixed_length</span><span class="o">=</span><span class="n">time_length</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">collate_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">seq_collate_fn</span><span class="p">,</span> <span class="n">token_pad_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_func</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="n">drop_last</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span> <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, NVIDIA

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>